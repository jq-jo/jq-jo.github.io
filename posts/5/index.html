
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>JQ Blog</title>
  <meta name="author" content="Jo">

  
  <meta name="description" content="Active Recordのコールバック Rails側では、内部でオブジェクトが作成されたり、更新されたり削除されたりする。コールバックとは、オブジェクトのライフサイクル期間における特定の瞬間に呼び出されるメソッドである。
コールバックを利用することで、Active Recordオブジェクトが作成 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jq-jo.github.io/posts/5">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="JQ Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">JQ Blog</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
  
  
  
  
  
    
      <form action="https://www.google.com/search" method="get">
        <fieldset role="search">
          <input type="hidden" name="sitesearch" value="jq-jo.github.io" />
    
          <input class="search" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
      </form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/01/25/railsmodelcallback/">RailsのModelのコールバック</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-01-25T14:30:52+09:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:30 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Active Recordのコールバック</h1>

<p>Rails側では、内部でオブジェクトが作成されたり、更新されたり削除されたりする。コールバックとは、オブジェクトのライフサイクル期間における特定の瞬間に呼び出されるメソッドである。<br>
コールバックを利用することで、Active Recordオブジェクトが作成、保存、更新、削除などのイベント発生の時に常に実行されるコードを書くことができる。</p>

<h3>種類と順番</h3>

<ul>
<li><p>オブジェクトの生成</p>

<ul>
<li>before_validation</li>
<li>after_validation</li>
<li>before_save</li>
<li>around_save</li>
<li>before_create</li>
<li>around_create</li>
<li>after_create</li>
<li>after_save</li>
</ul>
</li>
<li><p>オブジェクトの更新</p>

<ul>
<li>before_validation</li>
<li>after_validation</li>
<li>before_save</li>
<li>around_save</li>
<li>before_update</li>
<li>around_update</li>
<li>after_update</li>
<li>after_save</li>
</ul>
</li>
<li><p>オブジェクトの削除</p>

<ul>
<li>before_destroy</li>
<li>around_destroy</li>
<li>after_destroy</li>
</ul>
</li>
<li><p>オブジェクトのinstance化</p>

<ul>
<li>after_initialize</li>
</ul>
</li>
<li><p>find</p>

<ul>
<li>after_find</li>
</ul>
</li>
<li><p>touch</p>

<ul>
<li>after_touch</li>
</ul>
</li>
</ul>


<h3>使い方</h3>

<p>普通にモデルクラスの中に書いたら良い。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Admin</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="n">before_validation</span> <span class="ss">:hoge</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hoge</span>
</span><span class='line'>    <span class="s2">&quot;何かのコード&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Admin</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="n">before_validation</span> <span class="k">do</span>
</span><span class='line'>    <span class="s2">&quot;何かのコード&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Admin</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="n">before_validation</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="s2">&quot;何かのコード&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>上の三つの書き方で自分が実行したい瞬間に実行されるコードを書くことができる。<br><br><br></p>

<h2>参照</h2>

<p><a href="https://railsguides.jp/active_record_callbacks.html">Active Record コールバック</a><br/>
<a href="http://ruby-rails.hatenadiary.com/entry/20141211/1418301640">Rails4でモデルのコールバックの一覧と順番</a><br/>
<a href="http://qiita.com/rtoya/items/29cef3e328299781a328">Railsのcallbackについて調べた</a><br/>
<a href="http://blog.toshimaru.net/active-record-callbacks/">ActiveRecordのコールバックの順序・コールバック内のロールバック処理について</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/01/18/rails-model-polymorphic/">RailsのモデルのSTI(Single Table Inheritance)とポリモーフィックの実装</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-01-18T14:02:52+09:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:02 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p>RailsのActiveRecordには単一テーブル継承(STI)とポリモーフィック関係という二つの便利な関係性設定がある。同じような機能を持っているモデルが多数存在してそのモデルたちをまとめたいときとか、多数のモデルが一つのモデルを持ちたいときなどの複雑な関係性をもっと簡単にしてくれるのでその二つの関係性をまとめる。</p>

<h1>STI</h1>

<h3>状況設定</h3>

<p>例えば、本とコンピューターを同時に管理するproductsというモデルを作る。もちろんbooks、computersの二つのモデルを作ってもできなくはないけどSTIを通して実装すればテーブルを作らなくてもproductsの一つのテーブルで管理できる。</p>

<h3>Productモデル作成</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rails g model product name:string price:integer type:string author:string category:string maker:string inch:integer
</span><span class='line'>$ rake db:migrate</span></code></pre></td></tr></table></div></figure>


<p>ここでtypeは必須になる。author, categoryはbookのために、maker, inchはcomputerのためのcolumnになる。</p>

<h3>class作成</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>こういうclassが作られたら実際に使いたいbook、computerのclassを作成。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">Product</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Computer</span> <span class="o">&lt;</span> <span class="no">Product</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>気をつけないとならないのはProductのclassを継承すること。<br>
これで設定は完了。<br>
すると、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Computer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;お得パソコン&#39;</span><span class="p">,</span> <span class="ss">price</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="ss">maker</span><span class="p">:</span> <span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="ss">inch</span><span class="p">:</span> <span class="mi">15</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>こういうふうにデータを作成したら</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">INSERT</span> <span class="no">INTO</span> <span class="s2">&quot;products&quot;</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;maker&quot;</span><span class="p">,</span> <span class="s2">&quot;inch&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span> <span class="no">VALUES</span> <span class="p">(</span><span class="vg">$1</span><span class="p">,</span> <span class="vg">$2</span><span class="p">,</span> <span class="vg">$3</span><span class="p">,</span> <span class="vg">$4</span><span class="p">,</span> <span class="vg">$5</span><span class="p">,</span> <span class="vg">$6</span><span class="p">,</span> <span class="vg">$7</span><span class="p">)</span> <span class="no">RETURNING</span> <span class="s2">&quot;id&quot;</span>  <span class="o">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;お得パソコン&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="mi">100000</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;Computer&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;maker&quot;</span><span class="p">,</span> <span class="s2">&quot;apple&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;inch&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="mi">2017</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">18</span> <span class="mi">08</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">39</span> <span class="no">UTC</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="mi">2017</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">18</span> <span class="mi">08</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">39</span> <span class="no">UTC</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>こんな結果になり、Productテーブルに保存される。typeはclass名になる。<br>
呼び出すのも簡単に<code>Computer.find(Product.id)</code>や<code>Computer.all</code>でできる。
<br><code>Computer.find(Product.id)</code>を実行したら</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="no">Computer</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;お得パソコン&quot;</span><span class="p">,</span> <span class="ss">price</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;Computer&quot;</span><span class="p">,</span> <span class="ss">author</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">category</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">maker</span><span class="p">:</span> <span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="ss">inch</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="ss">created_at</span><span class="p">:</span> <span class="s2">&quot;2017-01-25 06:44:17&quot;</span><span class="p">,</span> <span class="ss">updated_at</span><span class="p">:</span> <span class="s2">&quot;2017-01-25 06:44:17&quot;</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>bookのために作ったcolumnは全部nilになる。つまり、一つのテーブルで三つのテーブルを使うようにはなるけど無駄なcolumnが多くなるデメリットもある。</p>

<h1>Polymorphic</h1>

<h3>状況設定</h3>

<p>プロジェクトの中で一つのモデルを多数のモデルに関係をつける時がある。<br>
例えば、掲示板の投稿をユーザーが作成した場合と管理者が作成した場合があるとするとPolymorphicで管理できる。<br></p>

<h3>ポリモフィックなテーブルの作成</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">admin</span> <span class="nb">name</span><span class="ss">:string</span> <span class="ss">email</span><span class="p">:</span><span class="n">string</span>
</span><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">user</span> <span class="nb">name</span><span class="ss">:string</span> <span class="ss">email</span><span class="p">:</span><span class="n">string</span>
</span><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">post</span> <span class="ss">owner</span><span class="p">:</span><span class="n">references</span><span class="p">{</span><span class="n">polymorphic</span><span class="p">}</span><span class="ss">:index</span> <span class="ss">title</span><span class="p">:</span><span class="n">string</span> <span class="ss">content</span><span class="p">:</span><span class="n">text</span>
</span><span class='line'><span class="err">$</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">migrate</span>
</span></code></pre></td></tr></table></div></figure>


<p>するとpostのmigrationは下記のようになる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreatePosts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:posts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:title</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ss">:content</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>モデルにbelongs_toとhas_many追加</h3>

<p>上記のように実行したらpostのクラスはさらにこういうふうになってます。そしてpostのテーブルにはowner_type, owner_idが生成されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>そこでadminとuser側だけhas_manyを追加したら良いです。<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Admin</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>実行</h3>

<p>そうした上にconsoleに下記のように実行してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">admin</span> <span class="o">=</span> <span class="no">Admin</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;admin1&#39;</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;admin@example.com&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;Admin id: 1, name: &quot;admin1&quot;, email: &quot;admin@example.com&quot;, created_at: &quot;2017-01-25 07:46:25&quot;, updated_at: &quot;2017-01-25 07:46:25&quot;&gt;</span>
</span><span class='line'><span class="n">post1</span> <span class="o">=</span> <span class="n">admin</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s1">&#39;post1&#39;</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s1">&#39;content1&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;Post id: 1, owner_type: &quot;Admin&quot;, owner_id: 1, title: &quot;post1&quot;, content: &quot;content1&quot;, created_at: &quot;2017-01-25 07:47:21&quot;, updated_at: &quot;2017-01-25 07:47:21&quot;&gt;</span>
</span><span class='line'><span class="n">post1</span><span class="o">.</span><span class="n">owner</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;Admin id: 1, name: &quot;admin1&quot;, email: &quot;admin@example.com&quot;, created_at: &quot;2017-01-25 07:46:25&quot;, updated_at: &quot;2017-01-25 07:46:25&quot;&gt;</span>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;user1&#39;</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;user@example.com&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;User id: 1, name: &quot;user1&quot;, email: &quot;user@example.com&quot;, created_at: &quot;2017-01-25 07:48:00&quot;, updated_at: &quot;2017-01-25 07:48:00&quot;&gt;</span>
</span><span class='line'><span class="n">post2</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s1">&#39;post2&#39;</span><span class="p">,</span> <span class="ss">content</span><span class="p">:</span> <span class="s1">&#39;content2&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;Post id: 2, owner_type: &quot;User&quot;, owner_id: 1, title: &quot;post2&quot;, content: &quot;content2&quot;, created_at: &quot;2017-01-25 07:49:04&quot;, updated_at: &quot;2017-01-25 07:49:04&quot;&gt;</span>
</span><span class='line'><span class="n">post2</span><span class="o">.</span><span class="n">owner</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;User id: 1, name: &quot;user1&quot;, email: &quot;user@example.com&quot;, created_at: &quot;2017-01-25 07:48:00&quot;, updated_at: &quot;2017-01-25 07:48:00&quot;&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">owner</span><span class="p">:</span> <span class="n">admin</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;Post id: 1, owner_type: &quot;Admin&quot;, owner_id: 1, title: &quot;post1&quot;, content: &quot;content1&quot;, created_at: &quot;2017-01-25 07:47:21&quot;, updated_at: &quot;2017-01-25 07:47:21&quot;&gt;</span>
</span><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">owner</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;Post id: 2, owner_type: &quot;User&quot;, owner_id: 1, title: &quot;post2&quot;, content: &quot;content2&quot;, created_at: &quot;2017-01-25 07:49:04&quot;, updated_at: &quot;2017-01-25 07:49:04&quot;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>こういうふうに活用できる。<br><br><br></p>

<h2>参照</h2>

<p><a href="http://ruby-rails.hatenadiary.com/entry/20141207/1417926599">Rails4でポリモフィックのリレーションを実装する</a><br/>
<a href="http://ruby-rails.hatenadiary.com/entry/20141206/1417839458">Rails4でSTI(単一継承テーブル)を行う</a><br/>
<a href="http://easyramble.com/rails-activerecord-single-table-inheritance.html">Rails ActiveRecordのSTI(Single Table Inheritance)の使い方</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/01/11/make-environment-xcode2/">ビルド環境設定(XCode)2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-01-11T10:04:36+09:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>10:04 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>問題</h2>

<p>この前、<a href="https://jq-jo.github.io/blog/2016/11/30/make-environment-xcode/">ここの記事</a>のようにビルド環境を分けようとしてたが、環境を分けるだけで環境別に変数を設定したりするのは一つ一つ書かないといけなかったので、あまりも効率的ではなっかたからもっといい方法があるだろうと思って調べた結果をまとめる。</p>

<h2>ソリューション</h2>

<p>例えば、Railsにはymlファイルに環境別に変数を設定したり、environmentsフォルダーにconfigの設定をするようにXCodeにもPlistファイルに設定して使う。<a href="https://jq-jo.github.io/blog/2016/11/30/make-environment-xcode/">前の記事</a>に続いてセッティングしたら良いと。</p>

<h2>使い方</h2>

<h3>1. info.plistを編集</h3>

<p><img src="https://monosnap.com/file/m0cQfWs4DcRqy48GpdP8N7iXD7q476.png" alt="Alt text" /></p>

<h3>2. Environment.plistを追加</h3>

<p>plistの新規作成
<img src="https://monosnap.com/file/0X16dE8UFtdkaPiXUQXUVciKRVWlp7.png" alt="Alt text" />
項目追加
<img src="https://monosnap.com/file/GNcdNK4Rw2X9hpdiFkIXmSrEpg88Xn.png" alt="Alt text" /></p>

<h3>3. AppDelegateに設定</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import UIKit
</span><span class='line'>
</span><span class='line'>@UIApplicationMain
</span><span class='line'>class AppDelegate: UIResponder, UIApplicationDelegate {
</span><span class='line'>
</span><span class='line'>  let bundle = NSBundle.bundle()
</span><span class='line'>  // Configuration取得
</span><span class='line'>  let configuration = bundle.infoDictionary!["Configuration"]
</span><span class='line'>
</span><span class='line'>  // Configurations.plist読み込み
</span><span class='line'>  let path = bundle.pathForResource("Environments", ofType: "plist")
</span><span class='line'>  let configurations = NSDictionary(contentsOfFile: path!)
</span><span class='line'>
</span><span class='line'>  // URL取得
</span><span class='line'>  let variables = configurations?.objectForKey(configuration!) as! [String : AnyObject]
</span><span class='line'>
</span><span class='line'>  let urlStr = variables["URL"]
</span><span class='line'>
</span><span class='line'>  (略)</span></code></pre></td></tr></table></div></figure>


<h3>4. ViewController</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import UIKit
</span><span class='line'>
</span><span class='line'>class ViewController: UIViewController, UIWebViewDelegate {
</span><span class='line'>
</span><span class='line'>  @IBOutlet weak var webView: UIWebView!
</span><span class='line'>  var appDelegate: AppDelegate = UIApplication.shared.delegate as! AppDelegate
</span><span class='line'>
</span><span class='line'>  override func viewDidLoad() {
</span><span class='line'>        super.viewDidLoad()
</span><span class='line'>        // Do any additional setup after loading the view, typically from a nib.
</span><span class='line'>        self.webView.delegate = self
</span><span class='line'>        let initialUrl = NSURL(string: self.appDelegate.urlStr)
</span><span class='line'>        let request = NSURLRequest(url:initialUrl as! URL)
</span><span class='line'>        self.webView.loadRequest(request as URLRequest)
</span><span class='line'>        webView.scrollView.isScrollEnabled = true
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  (略)</span></code></pre></td></tr></table></div></figure>


<h3>5. 使いやすい方法</h3>

<p>Configurationクラスを新規作成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import Foundation
</span><span class='line'>
</span><span class='line'>final class ConfigurationManager {
</span><span class='line'>
</span><span class='line'>    private static let sharedInstance = ConfigurationManager()
</span><span class='line'>
</span><span class='line'>    private var configuration: String
</span><span class='line'>    private var variables: NSDictionary
</span><span class='line'>
</span><span class='line'>    private init() {
</span><span class='line'>
</span><span class='line'>        // Singletonの確認用
</span><span class='line'>        print("Configuration initialization")
</span><span class='line'>
</span><span class='line'>        let bundle = Bundle.main
</span><span class='line'>        // Fetch Current Configuration
</span><span class='line'>        self.configuration = (bundle.infoDictionary?["Configuration"]) as! String
</span><span class='line'>        // Load Configurations
</span><span class='line'>        guard let path = bundle.path(forResource: "Environments", ofType: "plist") else {
</span><span class='line'>            self.variables = [:]
</span><span class='line'>            return
</span><span class='line'>        }
</span><span class='line'>        let configurations =  NSDictionary(contentsOfFile: path)
</span><span class='line'>        // Load Variables for Current Configuration
</span><span class='line'>        self.variables = configurations?.object(forKey: self.configuration) as! NSDictionary
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    class func Configuration() -&gt; String {
</span><span class='line'>        return sharedInstance.configuration
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    class func URL() -&gt; String {
</span><span class='line'>        guard let url = sharedInstance.variables["URL"] else {
</span><span class='line'>            return ""
</span><span class='line'>        }
</span><span class='line'>        return url as! String
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Appdelegate編集</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import UIKit
</span><span class='line'>
</span><span class='line'>@UIApplicationMain
</span><span class='line'>class AppDelegate: UIResponder, UIApplicationDelegate {
</span><span class='line'>
</span><span class='line'>  let urlStr = ConfigurationManager.URL()
</span><span class='line'>
</span><span class='line'>  (略)</span></code></pre></td></tr></table></div></figure>


<h3>6. 結果</h3>

<div>
<img src="https://monosnap.com/file/MWaisZvYficmUHFcvpSzpnfSYdQlrP.png" style="width: 32%;">
<img src="https://monosnap.com/file/SaK6q623KKMxNVnA3S9ErtUghksOFD.png" style="width: 32%;">
<img src="https://monosnap.com/file/kGcje9rS0P0UScxwBoq7bKX65ijm4m.png" style="width: 32%;">
</div>


<h2>適用</h2>

<h3>1. Environment.plistに追加</h3>

<p><img src="https://monosnap.com/file/bnSdtBjYdERQ8AV4u30YbvbC6VxJ60.png" alt="Alt text" /></p>

<h3>2. ConfigurationManager.swiftにコード追加</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import Foundation
</span><span class='line'>
</span><span class='line'>final class ConfigurationManager {
</span><span class='line'>
</span><span class='line'>  (略)
</span><span class='line'>
</span><span class='line'>  class func BarColor() -&gt; NSDictionary {
</span><span class='line'>      guard let barColor = sharedInstance.variables["BarColor"] else {
</span><span class='line'>          return "" as! NSDictionary
</span><span class='line'>      }
</span><span class='line'>      return barColor as! NSDictionary
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>3. AppDelegate</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import UIKit
</span><span class='line'>
</span><span class='line'>@UIApplicationMain
</span><span class='line'>class AppDelegate: UIResponder, UIApplicationDelegate {
</span><span class='line'>
</span><span class='line'>  var window: UIWindow?
</span><span class='line'>  let urlStr = ConfigurationManager.URL()
</span><span class='line'>  let barColor = ConfigurationManager.BarColor()
</span><span class='line'>  let appEnvironment = ConfigurationManager.Configuration()
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?) -&gt; Bool {
</span><span class='line'>      // Override point for customization after application launch.
</span><span class='line'>
</span><span class='line'>      return true
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  (略)
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>4. ViewController</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import UIKit
</span><span class='line'>
</span><span class='line'>class ViewController: UIViewController, UIWebViewDelegate {
</span><span class='line'>
</span><span class='line'>    @IBOutlet weak var webView: UIWebView!
</span><span class='line'>    var appDelegate: AppDelegate = UIApplication.shared.delegate as! AppDelegate
</span><span class='line'>    @IBOutlet weak var Environment: UILabel!
</span><span class='line'>
</span><span class='line'>    override func viewDidLoad() {
</span><span class='line'>        super.viewDidLoad()
</span><span class='line'>        // Do any additional setup after loading the view, typically from a nib.
</span><span class='line'>        self.webView.delegate = self
</span><span class='line'>        let initialUrl = NSURL(string: self.appDelegate.urlStr)
</span><span class='line'>        let request = NSURLRequest(url:initialUrl as! URL)
</span><span class='line'>        self.webView.loadRequest(request as URLRequest)
</span><span class='line'>        webView.scrollView.isScrollEnabled = true
</span><span class='line'>        Environment.text = appDelegate.appEnvironment
</span><span class='line'>        Environment.backgroundColor = UIColor(red: self.appDelegate.barColor["Red"] as! CGFloat, green: self.appDelegate.barColor["Green"] as! CGFloat, blue: self.appDelegate.barColor["Blue"] as! CGFloat, alpha: 1.0)
</span><span class='line'>        Environment.textColor = UIColor.white
</span><span class='line'>        Environment.textAlignment = .center
</span><span class='line'>
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    override func didReceiveMemoryWarning() {
</span><span class='line'>        super.didReceiveMemoryWarning()
</span><span class='line'>        // Dispose of any resources that can be recreated.
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>5. 結果</h3>

<div>
<img src="https://monosnap.com/file/ELhzOprPWibPz7EijtFXFE6PTbSGjt.png" style="width: 32%;">
<img src="https://monosnap.com/file/77vXKNb9cyZiR1RAqi1MHzrzlyHUri.png" style="width: 32%;">
<img src="https://monosnap.com/file/GyBMCa15r5EI6uNLBU069dBu1D2AZl.png" style="width: 32%;">
</div>


<p><br><br></p>

<h2>参照</h2>

<p><a href="http://stackoverflow.com/questions/40230396/ios-simple-way-to-manage-rest-end-points/40230742#40230742">http://stackoverflow.com/questions/40230396/ios-simple-way-to-manage-rest-end-points/40230742#40230742</a><br>
<a href="http://qiita.com/negibouze/items/1c1c977cab5ef26224fd">http://qiita.com/negibouze/items/1c1c977cab5ef26224fd</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/21/make-environment-androidstudio2/">ビルド環境設定(Android Studio)2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-12-21T18:05:11+09:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2016</span></span> <span class='time'>6:05 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>はじめに</h2>

<p>前回にAndroidStudio, XCodeのビルド環境設定の記事を書いたとき、環境変数とか環境によって違う機能を分けることについてもっといい方法があるんじゃないかなという疑問ができたので調べてみたのをまとめた。<br>
その中で見つけたのが<code>buildConfigField</code>だった。
<br><code>buildConfigField</code>は<code>build.gradle</code>の<code>buildTypes</code>、<code>productFlavors</code>に使える定義するものである。<br></p>

<h3>gradle.properties</h3>

<p>ちなみに、<code>build.gradle</code>はgitや他のバージョン管理ツールで公開されるので直接書くのではなくて、<code>gradle.properties</code>から読み込む方法をとる。<br>
まずは<code>gradle.properties</code>に設定をする。<code>build.gradle</code>にはString、int、array、double、floatなどいろんなobjectを宣言可能だが今回はシンプルにwebviewのurlを使うためのStringを設定してみる。<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">google_url</span><span class="o">=</span><span class="nl">https:</span><span class="c1">//www.google.co.jp</span>
</span><span class='line'><span class="n">yahoo_url</span><span class="o">=</span><span class="nl">http:</span><span class="c1">//www.yahoo.co.jp</span>
</span></code></pre></td></tr></table></div></figure>


<p><br><code>gradle.properties</code>に設定をしたら<code>build.gradle</code>にも設定をする。<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">productFlavors</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">google</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">buildConfigField</span><span class="o">(</span><span class="s">&quot;String&quot;</span><span class="o">,</span> <span class="s">&quot;MAIN_URL&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;${google_url}\&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">yahoo</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">buildConfigField</span><span class="o">(</span><span class="s">&quot;String&quot;</span><span class="o">,</span> <span class="s">&quot;MAIN_URL&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;${yahoo_url}\&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>第一変数はobjectの種類、第二変数は実際に使う名前、第三変数は<code>gradle.properties</code>で設定した名前になる。こういうふうにしたらすぐ使えるようになる。それではwebviewのところで<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">mWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">MAIN_URL</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>こんなにstatic変数のように使う。すると、<br></p>

<div style="width: 49%; float: left;">
<img src="https://monosnap.com/file/6vuaeg3dXBGYdX8KNGlshaopTD8pDU.png">
<p style="text-align: center;">yahooのFlavors</p>
</div>


<div style="width: 49%; float: left;">
<img src="https://monosnap.com/file/h9z6kCp1JQEwOimWquoTEwezalKVu2.png">
<p style="text-align: center;">googleのFlavors</p>
</div>


<p><br>
これの上にアプリの名前も変えてみよう。
<br><code>gradle.properties</code>にアプリの名前に使うStringを設定する。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">google_url</span><span class="o">=</span><span class="nl">https:</span><span class="c1">//www.google.co.jp</span>
</span><span class='line'><span class="n">yahoo_url</span><span class="o">=</span><span class="nl">http:</span><span class="c1">//www.yahoo.co.jp</span>
</span><span class='line'><span class="n">google_appName</span><span class="o">=</span><span class="n">Googleアプリ</span>
</span><span class='line'><span class="n">yahoo_appName</span><span class="o">=</span><span class="n">Yahooアプリ</span>
</span></code></pre></td></tr></table></div></figure>


<p>あと、<code>build.gradle</code>に追加します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">productFlavors</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">google</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">buildConfigField</span><span class="o">(</span><span class="s">&quot;String&quot;</span><span class="o">,</span> <span class="s">&quot;MAIN_URL&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;${google_url}\&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">resValue</span> <span class="s">&quot;string&quot;</span><span class="o">,</span> <span class="s">&quot;appName&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;${google_appName}\&quot;&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">yahoo</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">buildConfigField</span><span class="o">(</span><span class="s">&quot;String&quot;</span><span class="o">,</span> <span class="s">&quot;MAIN_URL&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;${yahoo_url}\&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">resValue</span> <span class="s">&quot;string&quot;</span><span class="o">,</span> <span class="s">&quot;appName&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;${yahoo_appName}\&quot;&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ちなみに<code>build.gradle</code>に<code>resValue</code>と設定したらリソースとして使用できる。<br>
第一変数はリソースの種類（ここはStringではなく、stringにすることを注意）、第二変数は実際に使う名前、第三変数は<code>gradle.properties</code>で設定した名前になる。そして<code>AndroidManifest</code>で<code>@string/appName</code>とすると、</p>

<div style="width: 49%; float: left;">
<img src="https://monosnap.com/file/RN5ZOAe570jot528uC0udeGXTBu38m.png">
<p style="text-align: center;">yahooのFlavors</p>
</div>


<div style="width: 49%; float: left;">
<img src="https://monosnap.com/file/MfFYzVlrySfsiFDZJpASY8rAZwyT7e.png">
<p style="text-align: center;">googleのFlavors</p>
</div>


<p>日本語がちゃんと出てこない。<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">productFlavors</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">google</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">buildConfigField</span><span class="o">(</span><span class="s">&quot;String&quot;</span><span class="o">,</span> <span class="s">&quot;MAIN_URL&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;${google_url}\&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">resValue</span> <span class="s">&quot;string&quot;</span><span class="o">,</span> <span class="s">&quot;appName&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;Googleアプリ\&quot;&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">yahoo</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">buildConfigField</span><span class="o">(</span><span class="s">&quot;String&quot;</span><span class="o">,</span> <span class="s">&quot;MAIN_URL&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;${yahoo_url}\&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">resValue</span> <span class="s">&quot;string&quot;</span><span class="o">,</span> <span class="s">&quot;appName&quot;</span><span class="o">,</span> <span class="s">&quot;\&quot;Yahooアプリ\&quot;&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br><code>productFlavors</code>に直接書いたら、</p>

<div style="width: 49%; float: left;">
<img src="https://monosnap.com/file/LCI9N7RqKUPYZ2YxA6347xXp6r8L5c.png">
<p style="text-align: center;">yahooのFlavors</p>
</div>


<div style="width: 49%; float: left;">
<img src="https://monosnap.com/file/AK7E4N7OVOUyItSQqKGZje8JWgHLmT.png">
<p style="text-align: center;">googleのFlavors</p>
</div>


<p><br>
アプリ名も変えられる。でもなんで日本語がうまく出てこないのかの疑問ができたので今度また調べてまとめることにしよう。<br><br><br></p>

<h2>参照</h2>

<p><small>
<a href="http://sakebook.hatenablog.com/entry/2015/11/20/015829"><a href="http://sakebook.hatenablog.com/entry/2015/11/20/015829">http://sakebook.hatenablog.com/entry/2015/11/20/015829</a></a>
<a href="http://ja.stackoverflow.com/questions/31140/androidstudio%E3%81%A7%E5%90%84%E3%83%93%E3%83%AB%E3%83%89%E3%81%AB%E3%81%9D%E3%82%8C%E3%81%9E%E3%82%8C%E3%81%AE%E5%A4%89%E6%95%B0%E3%82%84%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%9C%E3%82%8B"><a href="http://ja.stackoverflow.com/questions/31140/androidstudio%E3%81%A7%E5%90%84%E3%83%93%E3%83%AB%E3%83%89%E3%81%AB%E3%81%9D%E3%82%8C%E3%81%9E%E3%82%8C%E3%81%AE%E5%A4%89%E6%95%B0%E3%82%84%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%9C%E3%82%8B">http://ja.stackoverflow.com/questions/31140/androidstudio%E3%81%A7%E5%90%84%E3%83%93%E3%83%AB%E3%83%89%E3%81%AB%E3%81%9D%E3%82%8C%E3%81%9E%E3%82%8C%E3%81%AE%E5%A4%89%E6%95%B0%E3%82%84%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%9C%E3%82%8B</a></a>
</small></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/30/make-environment-xcode/">ビルド環境設定(XCode)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-11-30T12:23:41+09:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:23 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>XCode</h2>

<p>XCodeの場合はTargetを分ける方法とConfigurationsを分ける方法の二つの方法がある。<br><br>
◎ Configurationsを分ける方法<br><br>
まず、プロジェクトのinfoタブでConfigurationsというところで追加させる。ReleaseとDebugがDefaultされてあるのでその中にStagingを入れてみる。<br>
<img src="https://monosnap.com/file/Q3O8utFKCtm5zg1p0Z3GoWfu4rFUco.png" alt="Alt text" />
<code>+</code>を押し、DebugかReleaseをduplicateして名前を変える。
<img src="https://monosnap.com/file/aFsMeAhXPgkctvXCw03jPw61GpWSpg.png" alt="Alt text" />
続いてTargetsのBuildSettingsの<code>+</code>を押し、User-DefinedにBUNDLE_DISPLAY_NAME_PREFIXとBUNDLE_IDENTIFIER_SUFFIXを追加する。そしてActiveConpilationConditionsも下のように変える。BUNDLE_DISPLAY_NAME_PREFIXはアプリ名を分けるために追加、BUNDLE_IDENTIFIER_SUFFIXはアプリのBundleIdをそれぞれ分けるために追加する。また、ActiveConpilationConditionsはそれぞれのビルドの機能を分岐させるために追加する。
<img src="https://monosnap.com/file/JK5RqnvNu5iG0jEU35kC6anLKbHFow.png" alt="Alt text" />
<img src="https://monosnap.com/file/8WwygchOcTeNfveXhUyVHMCJj9DMsH.png" alt="Alt text" />
次はschemeを分けて管理する。左上のschemeのところで<code>New Scheme</code>を押してDebugとStagingのschemeを追加する。また、<code>Edit Scheme</code>でRelease,Debug,Stagingのそれぞれの設定をする。
<img src="https://monosnap.com/file/DdgdmUzq2UVIa30kWZiptqU0KKSvy5.png" alt="Alt text" />
<img src="https://monosnap.com/file/4eeSZVYzL1r3c852b7yzzeYBxSWOKS.png" alt="Alt text" />
そこまでできたらTargetsのinfoでBundle identifierとBundle nameを変更する。Bundle identifierは$(PRODUCT_BUNDLE_IDENTIFIER)の後ろに$(BUNDLE_IDENTIFIER_SUFFIX)を、Bundle nameは$(PRODUCT_NAME)の前に$(BUNDLE_DISPLAY_NAME_PREFIX)を入れる。
<img src="https://monosnap.com/file/hZBoQgZnVpl9OVgYINvjgOOubUTsoH.png" alt="Alt text" />
そうすれば下のようにGeneralで変更されたのを確認できる。
<img src="https://monosnap.com/file/vdIoWGmaDrrt8nGg5rI1uMkdodxCJa.png" alt="Alt text" />
それぞれのビルドに機能を分岐させる場合は下のように<code>#if</code>を使う。#ifのところにさっきのActiveConpilationConditionsに設定したのを入れる。
<img src="https://monosnap.com/file/lTp2TdWE3BsKrapycZtPep3lJoEEWl.png" alt="Alt text" />
ビルド別にビルドしてみると、<br></p>

<h5>Release</h5>

<p><img src="https://monosnap.com/file/QkGImbr37gD8Y7JyAvxxpi52zoHuPV.png" alt="Alt text" /></p>

<h5>Debug</h5>

<p><img src="https://monosnap.com/file/KlSkLEKfDVMXsWl7MyN3XzsPIbrVvL.png" alt="Alt text" /></p>

<h5>Staging</h5>

<p><img src="https://monosnap.com/file/raVMMgsr3Gvy02ih0hUZy86pxPZIkC.png" alt="Alt text" />
それぞれ違うソースコードが実行されたことをみることができる。<br>
インストールされたデバイスをみたら、
<img src="https://monosnap.com/file/MKAP87DCtdgFOg0kcTQo3IJqS7r4cM.png" alt="Alt text" />
三つのアプリがインストールされる。<br><br>
◎ Targetを分ける方法<br><br>
今のTargetをduplicateしてもう一つのTargetを作る。もちろん<code>+</code>で追加しても良いが、同じソースコードを使うならばduplicateでも全然構わない。作ったら名前を変更し、また自動にinfo.plistファイルも生成されるのでそれのファイル名も変更。その後にGeneralでinfo.plistを選んで設定する。
<img src="https://monosnap.com/file/lM4SmNEhPp2AIL61Z6rKJOmyEGGq3H.png" alt="Alt text" />
そしてBuild SettingsでProduct Bundle Identifierを変更すればする。
<img src="https://monosnap.com/file/hBfhNcDfOoPxGT2mrNAaLe5jCbBbwj.png" alt="Alt text" />
さっきと同じようにschemeを追加する。
<img src="https://monosnap.com/file/78PpR1UeYXfOGLrywsrJP0fr6b7E5M.png" alt="Alt text" />
ActiveConpilationConditionsをカスタマイズするが、Targetを間違わないよう気をつける。
<img src="https://monosnap.com/file/yq1WCEKKQIKD8NcEFOCkblOp1ypMjV.png" alt="Alt text" />
さっきの分岐のうえにさらに分岐してみる。
<img src="https://monosnap.com/file/Vqy7Sz343KYnnO1WokdGwBafGhTqUP.png" alt="Alt text" />
すると、新たのプロジェクトのRelease,Debug,Stagingをそれぞれ使うことができる。
<img src="https://monosnap.com/file/E7uYaDWIxb8G3meokqY7V0JffVggzP.png" alt="Alt text" />
<img src="https://monosnap.com/file/ia7prDT8OLMrKf9jHhd637uHXBgoJ6.png" alt="Alt text" />
<img src="https://monosnap.com/file/mHxnMnR7C8ikmFrdsY6GYEUHcvoczK.png" alt="Alt text" />
そして、デバイスで確認してみるとまた三つが増えて六つもアプリがインストールされたのを確認できる。
<img src="https://monosnap.com/file/3v0ZtxQX4GRtZmgy7DGF5EhmKlBjal.png" alt="Alt text" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/23/make-environment-androidstudio/">ビルド環境設定(Android Studio)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-11-23T13:39:57+09:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2016</span></span> <span class='time'>1:39 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p>アプリを開発するとき、ビルドを分けて開発することになるので、ビルド環境を分ける方法についてまとめてみた。<br></p>

<h2>AndroidStudio</h2>

<p>AndroidStudioの場合はモジュールのbuild.gradleで設定ができる。<br>
最初プロジェクトを作ってbuild.gradleをみると下のようにdebugとreleaseがdefaultに設定されているのが確認できる。
<img src="https://monosnap.com/file/pNizvnR2X6tz1YG7GUeq4wIGYKCkvH.png" alt="Alt text" />
環境を分けるには二つの方法がある。buildTypesを追加するのとproductFlavorsを追加すること。<br><br></p>

<h3>BuildTypes</h3>

<p>まず、staging環境を作りたいとしたら、<br>
上段のバーの Build -> Edit Build Types のところでビルドタイプを下のように追加する。<br>
<img src="https://monosnap.com/file/vO2FJYYgTWtXXpSfhiil1IfdlCK3NF.png" alt="Alt text" />
<img src="https://monosnap.com/file/L4ZeARWVwNTfM4Smuja6UKEA3x69Cx.png" alt="Alt text" />
すると、buildTypesに追加されることが確認できる。<br>
<img src="https://monosnap.com/file/fjGAYTKan4QwnhvuIo0wTPuVcHNpNF.png" alt="Alt text" />
もし、それぞれの機能や設定を指定する場合は、たとえば、Webviewのそれぞれのurlをセッティングするときだとしたら<code>BuildConfig.BUILD_TYPE</code>メソッドを使って分岐して処理することができる。<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">BuildConfig</span><span class="o">.</span><span class="na">BUILD_TYPE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;debug&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">DEV_URL</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">BuildConfig</span><span class="o">.</span><span class="na">BUILD_TYPE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;staging&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">STG_URL</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">RELEASE_URL</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br></p>

<h3>ProductFlavors</h3>

<p>ここで同じソースコードを使って別のアプリを作らなきゃいけないときがあるかもしれない。たとえば、無料バージョンと有料バージョンを分けるとしたらProductFlavorsを設定する。<br>
上段のバーの Build -> Edit Flavor のところでflavorを追加する。
<img src="https://monosnap.com/file/pn0WWImKCE39t8ETMptxCjnYx0aalG.png" alt="Alt text" />
<img src="https://monosnap.com/file/0pxdvAQsB58VpXH4e4GUfaLn7n0a9e.png" alt="Alt text" />
すると、productFlavorsに追加されることが確認できる。
<img src="https://monosnap.com/file/C4PkorQHyCFBiovzwAxd49zn9ZBEu5.png" alt="Alt text" />
productFlavorsも<code>BuildConfig.FLAVOR</code>を使って分岐ができる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">BuildConfig</span><span class="o">.</span><span class="na">FLAVOR</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;free&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">FREE_URL</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mWebView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">PAID_URL</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br>
上の画像をみたらわかるように各flavorの下にbuildTypesがつく。今までのセッティングでfreeDebug,freeStaging,freeRelease,paidDebug,paidStaging,paidRelease全部で6個のビルドが生成される。<br>
で、問題はこの分けられた6個のビルドのapplicationIdやversionNameが同じでインストールやリリースのときにうまくできないことだ。なので、<code>applicationIdSuffix</code>,<code>versionNameSuffix</code>を使ってそれぞれのapplicationIdとversionNameを持つようにする。<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">buildTypes</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">release</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">staging</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">applicationIdSuffix</span> <span class="err">&#39;</span><span class="o">.</span><span class="na">staging</span><span class="err">&#39;</span>
</span><span class='line'>        <span class="n">versionNameSuffix</span> <span class="err">&#39;</span><span class="o">-</span><span class="n">staging</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">debug</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">applicationIdSuffix</span> <span class="err">&#39;</span><span class="o">.</span><span class="na">debug</span><span class="err">&#39;</span>
</span><span class='line'>        <span class="n">versionNameSuffix</span> <span class="err">&#39;</span><span class="o">-</span><span class="n">debug</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">productFlavors</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">paid</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">applicationIdSuffix</span> <span class="err">&#39;</span><span class="o">.</span><span class="na">free</span><span class="err">&#39;</span>
</span><span class='line'>        <span class="n">versionNameSuffix</span> <span class="err">&#39;</span><span class="o">-</span><span class="n">free</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">free</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">applicationIdSuffix</span> <span class="err">&#39;</span><span class="o">.</span><span class="na">staging</span><span class="err">&#39;</span>
</span><span class='line'>        <span class="n">versionNameSuffix</span> <span class="err">&#39;</span><span class="o">-</span><span class="n">staging</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>そして、アプリ名も別にする必要があるので設定させる。アプリ名はAndroidManifestで変更できるが。<br>
<img src="https://monosnap.com/file/I2Qyc3kkI1gSyQP8P3wvdVNwpJtCLF.png" alt="Alt text" />
build.gradleで<code>manifestPlaceholders</code>を使ったらAndroidManifestで使用できる。たとえば、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">manifestPlaceholders</span> <span class="o">=</span> <span class="o">[</span><span class="nl">appName:</span> <span class="s">&quot;environment&quot;</span><span class="o">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>上のように設定すると、AndroidManifestで</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">android:</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;${appName}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>こういうふうに使うことができる。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/16/firebase-cloud-messaging-android/">Firebase Cloud Message in Android</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-11-16T17:31:59+09:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>5:31 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>FCM 使い方</h2>

<h3>Android</h3>

<ul>
<li>Firebaseにアプリを登録
<img src="https://monosnap.com/file/hIBBp9sb8ANT14AWzJOYekZ9aumLlc.png" alt="Alt text" /></li>
<li><p>build.gradle編集</p>

<ul>
<li>ルートレベルのbuild.gradle</li>
</ul>


<p>ルートレベルのbuild.gradleにgoogle-services プラグインを指定する。</p>

<pre><code>buildscript {
  // ...
  dependencies {
    // ...
    classpath 'com.google.gms:google-services:3.0.0'
  }
}
</code></pre>

<ul>
<li>モジュールのbuild.gradle</li>
</ul>


<p>モジュールのGradleファイル(通常は app/build.gradle)の末尾に apply plugin の行を追加し、Gradleプラグインを有効化する。<br>
必要なライブラリをdependenciesのところに書く。</p>

<pre><code>apply plugin: 'com.android.application'

android {
  // ...
}

dependencies {
  // ...
  compile 'com.google.firebase:firebase-messaging:9.6.1'
}

apply plugin: 'com.google.gms.google-services'
</code></pre></li>
<li><p>アプリのマニフェストを編集</p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;service
</span><span class='line'>    android:name=".MyFirebaseMessagingService"&gt;
</span><span class='line'>    &lt;intent-filter&gt;
</span><span class='line'>        &lt;action android:name="com.google.firebase.MESSAGING_EVENT"/&gt;
</span><span class='line'>    &lt;/intent-filter&gt;
</span><span class='line'>&lt;/service&gt;
</span><span class='line'>
</span><span class='line'>    ...
</span><span class='line'>
</span><span class='line'>&lt;service
</span><span class='line'>    android:name=".MyFirebaseInstanceIDService"&gt;
</span><span class='line'>    &lt;intent-filter&gt;
</span><span class='line'>        &lt;action android:name="com.google.firebase.INSTANCE_ID_EVENT"/&gt;
</span><span class='line'>    &lt;/intent-filter&gt;
</span><span class='line'>&lt;/service&gt;</span></code></pre></td></tr></table></div></figure>


<ul>
<li>google-services.json
google-services.jsonファイルをFirebaseコンソールからダウンロードし、プロジェクトに入れ込む。
<img src="https://monosnap.com/file/p8uiAYlbEALAWjL0TjsH4Yz4lPc8ei.png" alt="Alt text" />
<img src="https://monosnap.com/file/YTXZIjFFnATOBSacyroYaotXk02imJ.png" alt="Alt text" /></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/16/firebase-cloud-messaging-ios/">Firebase Cloud Message in iOS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-11-16T15:29:27+09:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>3:29 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h1>FCM (Firebase Cloud Message)</h1>

<h2>Firebaseとは</h2>

<p>FirebaseはGoogleが運営しているmBaaS(Mobile Backend as a Service)であり、Backend as a Serviceとは一般的にアプリケーションに要求される色んな機能をまとめて提供してくれるサービスだ。</p>

<h2>Firebaseの提供機能</h2>

<ol>
<li>Analytics</li>
<li>Cloud Messaging</li>
<li>認証</li>
<li>Realtime Database</li>
<li>Storage</li>
<li>Hosting</li>
<li>Remote Config</li>
<li>Test Lab</li>
<li>Crash Reporting</li>
<li>Notifications</li>
<li>App Indexing</li>
<li>Dynamic Links</li>
<li>Invites</li>
<li>AdWords</li>
</ol>


<p><br>詳しい情報はこちら。<br>
&ndash; <a href="https://firebase.google.com/features/">https://firebase.google.com/features/</a><br><br></p>

<p>値段によってプランがそれぞれ違うけど、もちろん無料プランもある<br>
<img src="https://monosnap.com/file/boWswwYmYeYfDDxw4cLJzxCr5rB1pK.png" alt="Alt text" /></p>

<h2>FCM 使い方</h2>

<h3>iOS (Swift基準)</h3>

<ul>
<li>Firebaseにアプリを登録<br>
<img src="https://monosnap.com/file/gpotQYhuSizvMb0v4eXnJtemkm7E9R.png" alt="Alt text" />
<img src="https://monosnap.com/file/vq9PlFYrWL6ARYj8iPlwI1dBLICUcO.png" alt="Alt text" />
<img src="https://monosnap.com/file/z8uyP5c2SQS2Kh1HF3bNSadeb9BUvw.png" alt="Alt text" /></li>
<li>pod追加<br>

<ul>
<li>まずcocoapodsをインストールする。</li>
</ul>
</li>
<li><pre><code>$ sudo gem install cocoapods
$ pod setup
</code></pre>

<ul>
<li>そしてPodfileを作る。</li>
</ul>
</li>
<li><pre><code>$ cd your-project directory
$ pod init
</code></pre>

<ul>
<li>Podfileが作られたらファイルの中に必要なpodを追加する。</li>
</ul>
</li>
<li><pre><code>pod 'Firebase/Messaging'
</code></pre>

<ul>
<li>podをインストールして.xcworkspaceファイルを開いてプロジェクトを確認する。</li>
</ul>
</li>
<li><pre><code>$ pod install
$ open your-project.xcworkspace
</code></pre>

<ul>
<li>FirebaseコンソールでGoogleService-Info.plistをダウンロードしてプロジェクトに入れる。</li>
</ul>
</li>
</ul>


<p><img src="https://monosnap.com/file/gT1lH6wOd02epXkIuURW9ZChZFSA8W.png" alt="Alt text" />
<img src="https://monosnap.com/file/RoO3sspdEKqfNxJpaX0iUqTkeQUz3v.png" alt="Alt text" /></p>

<ul>
<li>ソースコード追加<br>
Firebaseには基本的なソースコードを提供してくれるのでそれを使えば少なくともサーバから送るプッシュ通知を受信するのはできる。

<ul>
<li><a href="https://github.com/firebase/quickstart-ios/tree/master/messaging/">https://github.com/firebase/quickstart-ios/tree/master/messaging/</a>
大事なのはiOS10とその以下のバージョンを分岐することと、
<code>
FIRApp.configure()
</code>
メソッドで初期化すること。後は自分の環境に合わせてメソッドをカスタマイズする。</li>
</ul>
</li>
<li>APNsのSSL証明書のプロビジョニング

<ul>
<li><a href="https://firebase.google.com/docs/cloud-messaging/ios/certs">https://firebase.google.com/docs/cloud-messaging/ios/certs</a></li>
</ul>
</li>
</ul>


<p>上記のリンクのとおり正しく進んだらp12ファイルを保存できるが、その保存したp12ファイルを下の画面にみえるところにアップすればセッティングは終わり。</p>

<p><img src="https://monosnap.com/file/ryYwUyf6v5XIx8aB1SYSx5TuNJE0Yi.png" alt="Alt text" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/26/mobile-app-sinsa/">iOS, Androidの申請</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-10-26T14:55:41+09:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>2:55 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>初めに</h2>

<p>アプリ申請の手順のまとめ。</p>

<hr style="border-top: solid 1px rgba(128, 128, 128, 0.2); border-bottom: solid 1px rgba(128, 128, 128, 0.2);">


<h3>使用機能</h3>

<ul>
<li>Android

<ul>
<li>Webview</li>
<li>Tab Layout</li>
<li>Push Notification</li>
<li>NativeのCamera, Album 機能</li>
</ul>
</li>
<li>iOS

<ul>
<li>UIWebview</li>
<li>UITabbar</li>
<li>Push Notification</li>
<li>NativeのCamera, Album 機能</li>
</ul>
</li>
</ul>


<hr style="border-top: solid 1px rgba(128, 128, 128, 0.2); border-bottom: solid 1px rgba(128, 128, 128, 0.2);">


<h3>手順</h3>

<ul>
<li>Android

<ul>
<li>まず、下の写真のように新しいアプリを追加する。
<img src="https://monosnap.com/file/0oft4oL4j2UnOa98R6QjH5RcRUXR1h.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/VHZebUIkyhPtiWz29Drj5yD3EXNNvR.png" alt="Alt text" /><br></li>
<li>APKをアップロードする。
<img src="https://monosnap.com/file/ovRWMylsbMP3zBG4xHyU69fSdaHYZ2.png" alt="Alt text" /><br></li>
<li>求められるものを手順に合わせて記入する。
<img src="https://monosnap.com/file/RJ2FabWM459r5NP1m2qUhDIixNdtFq.png" alt="Alt text" /><br>

<ul>
<li>必須項目

<ul>
<li>タイトル(30文字)</li>
<li>簡単な説明(80文字)</li>
<li>詳しい説明(4000文字)</li>
<li>スクリーンショット(2枚)</li>
<li>高解像度アイコン(512x512, 32ビットPNG)</li>
<li>ヘッダー画像(横1,024x縦500, JPGまたは24ビットPNG)</li>
<li>アプリのタイプ</li>
<li>カテゴリ</li>
<li>コンテンツのレーティング</li>
<li>新しいコンテンツ レーティング</li>
<li>メール(連絡先のメールアドレスを入力, このアドレスはアプリと一緒に公開される)</li>
<li>プライバシー ポリシー
<img src="https://monosnap.com/file/AQ9iFtxUtatRKZHalXtO1jUmRCwgwr.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/f1dRjy5c5vRC0QIJEt3yutZno2bjbN.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/5ChIltchsvT4XpSA0OSuLQsMEreTKS.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/NpPqSIsqPI3qRMtYTGSzE0qWscsQi1.png" alt="Alt text" /><br></li>
</ul>
</li>
</ul>
</li>
<li>コンテンツのレーティングを取る。
<img src="https://monosnap.com/file/Y8GJYzYgJogJSsc3PIjjcCRBvqZo2b.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/09bxiDWaQbxLHGgS0b6G0MiiphXkFM.png" alt="Alt text" /><br></li>
<li>価格と販売/配布地域を設定する。

<ul>
<li>必須項目

<ul>
<li>国</li>
<li>広告を含む</li>
<li>コンテンツ ガイドライン</li>
<li>米国輸出法
<img src="https://monosnap.com/file/HuuNV8YxC8Oez7qgdd3g5kbXkLX4kF.png" alt="Alt text" /><br></li>
</ul>
</li>
</ul>
</li>
<li>下の写真のように全部記入すればチェック表示が現れアプリを公開できるようになる。
<img src="https://monosnap.com/file/YaoEiy4ny2tqtA1zu17DTjXArb5QOi.png" alt="Alt text" /><br></li>
</ul>
</li>
</ul>


<hr style="border-top: solid 1px rgba(128, 128, 128, 0.2); border-bottom: solid 1px rgba(128, 128, 128, 0.2);">


<ul>
<li>iOS

<ul>
<li>新規アプリを登録する。
<img src="https://monosnap.com/file/EtKbeKmRmOpJ0CtEIwbaXR8DJTUVkV.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/d6DRNAO6q6In0z8LkgxtH6aZoY0YIT.png" alt="Alt text" /><br></li>
<li>Appleは必須項目とかは別に書いてないのでできるかぎり全部記入する方が良いと思う。
<img src="https://monosnap.com/file/wdsW9eSrTlTbEpqJCWCl4TdMd2YvbR.png" alt="Alt text" /><br></li>
<li>Appleはスクリーンショットにかなり厳しい。

<ul>
<li>プレビュー, スクリーンショット

<ul>
<li>5.5インチディスプレイ(App プレビュー(1枚) / スクリーンショット(5枚))

<ul>
<li>72 dpi, RGB, flattened, no transparency</li>
<li>High-quality JPEG or PNG image file format</li>
<li>1242 x 2208 pixels for hi-res portrait</li>
<li>2208 x 1242 pixels for hi-res landscape</li>
</ul>
</li>
<li>4.7インチディスプレイ(App プレビュー(1枚) / スクリーンショット(5枚))

<ul>
<li>72 dpi, RGB, flattened, no transparency</li>
<li>High-quality JPEG or PNG image file format</li>
<li>750 x 1334 pixels for hi-res portrait</li>
<li>1334 x 750 pixels for hi-res landscape</li>
</ul>
</li>
<li>4.0インチディスプレイ(App プレビュー(1枚) / スクリーンショット(5枚))

<ul>
<li>72 dpi, RGB, flattened, no transparency</li>
<li>High-quality JPEG or PNG image file format</li>
<li>Any of the following sizes:

<ul>
<li>640 x 1096 pixels for portrait (without status bar) minimum</li>
<li>640 x 1136 pixels for portrait (full screen) maximum</li>
<li>1136 x 600 pixels for landscape (without status bar) minimum</li>
<li>1136 x 640 pixels for landscape (full screen) minimum</li>
</ul>
</li>
</ul>
</li>
<li>3.5インチディスプレイ(App プレビュー(1枚) / スクリーンショット(5枚))

<ul>
<li>72 dpi, RGB, flattened, no transparency</li>
<li>High-quality JPEG or PNG image file format</li>
<li>Any of the following sizes:

<ul>
<li>640 x 920 pixels for hi-res portrait (without status bar) minimum</li>
<li>640 x 960 pixels for hi-res portrait (full screen) maximum</li>
<li>960 x 600 pixels for hi-res landscape (without status bar) minimum</li>
<li>960 x 640 pixels for hi-res landscape (full screen) maximum</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<p><img src="https://monosnap.com/file/vJ3VbzFkAfmhyYocoogIO343pmLpZK.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/GhF8DbfUculAL7fEFcDHkFE27zfhh3.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/yTh8YX221tKUiHkLbrypQL9yJlWpXM.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/Ioi3mDx6cI07SZNyKQjva6AsHlxlKe.png" alt="Alt text" /><br>
<img src="https://monosnap.com/file/KYltYTL3Takh69RnoQVLkTA8lazHaR.png" alt="Alt text" /><br>
iOSはプレビューとスクリーンショット以外にはそんなに難しくはないので早めに終わらせるが、審査はAndroidが1日で終わる反面iOSは一週間くらいかかるし、審査も厳しくてよくrejectされる</p>

<h2>追記</h2>

<ul>
<li>Reject

<ul>
<li>私の場合はセーフティーの項目にリジェクトされた。ソーシャル、コミュニティ系のアプリはユーザへのセーフティメカニズムが必要らしい。アップルからのメッセージは

<ul>
<li>不快なコンテンツをフィルタリングするための方法。</li>
<li>不快なコンテンツのユーザーのためのメカニズム。</li>
<li>不正なユーザをブロックするためのメカニズム。</li>
<li>開発者は、不快なコンテンツを削除し、問題のあるコンテンツを提供するユーザーを吐出することにより、24時間以内に好ましくないコンテンツレポートに行動しなければなりません。</li>
</ul>
</li>
</ul>
</li>
<li>解決

<ul>
<li>特定のユーザへのブロック機能を入れることで解決できた</li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/19/android-camera-gallery/">Androidでカメラ＆ギャラリーの使い方</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-10-19T14:51:05+09:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>2:51 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>はじめに</h2>

<hr style="border-top: solid 1px rgba(128, 128, 128, 0.2); border-bottom: solid 1px rgba(128, 128, 128, 0.2);">


<p>今回のinuckのアプリでファイルアップロードのためにカメラやギャラリーの機能を使って、Android側でも対応することになりましたので情報をまとめました。</p>

<h2>説明</h2>

<hr style="border-top: solid 1px rgba(128, 128, 128, 0.2); border-bottom: solid 1px rgba(128, 128, 128, 0.2);">


<p>Android 4.4に変わってからWebviewはChromium基盤として変更されたため、WebviewにもMobile Chrome Browserと同じようなレベルのパフォーマンスを持って最新HTML5やCSS3のWeb標準をサポートし、V8 Javascript エンジンを乗せた最新バージョンに適用しました。<br>
なので、Webviewのパフォーマンスについて色んな変更が発生され、ここで話すファイルアップロードについた部分も適用されました。
ここには4.4以外のバージョンをまとめます。</p>

<h2>権限</h2>

<hr style="border-top: solid 1px rgba(128, 128, 128, 0.2); border-bottom: solid 1px rgba(128, 128, 128, 0.2);">


<h3>AndroidManifest.xml</h3>

<p>まず、Permissionを設定します。<br>
カメラとギャラリーを使うためには<br>
この三つが必要です。<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.CAMERA&quot;</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span><span class="o">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>この三つをAndroidManifestに入れます。<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="o">?&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">manifest</span> <span class="nl">xmlns:</span><span class="n">android</span><span class="o">=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="n">package</span><span class="o">=</span><span class="s">&quot;jp.inuck.inuckapp&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.INTERNET&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.CAMERA&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">application</span>
</span><span class='line'>        <span class="nl">android:</span><span class="n">allowBackup</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="nl">android:</span><span class="n">icon</span><span class="o">=</span><span class="s">&quot;@mipmap/ic_launcher&quot;</span>
</span><span class='line'>        <span class="nl">android:</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;@string/app_name&quot;</span>
</span><span class='line'>        <span class="nl">android:</span><span class="n">supportsRtl</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="nl">android:</span><span class="n">theme</span><span class="o">=</span><span class="s">&quot;@style/AppTheme&quot;</span>
</span><span class='line'>        <span class="nl">android:</span><span class="n">minSdkVersion</span><span class="o">=</span><span class="s">&quot;8&quot;</span>
</span><span class='line'>        <span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="n">activity</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;.MainActivity&quot;</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="n">intent</span><span class="o">-</span><span class="n">filter</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="n">action</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.intent.action.MAIN&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>
</span><span class='line'>                <span class="o">&lt;</span><span class="n">category</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>            <span class="o">&lt;/</span><span class="n">intent</span><span class="o">-</span><span class="n">filter</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;/</span><span class="n">activity</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="n">service</span>
</span><span class='line'>            <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;.MyFirebaseMessagingService&quot;</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="n">intent</span><span class="o">-</span><span class="n">filter</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="n">action</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;com.google.firebase.MESSAGING_EVENT&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>            <span class="o">&lt;/</span><span class="n">intent</span><span class="o">-</span><span class="n">filter</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;/</span><span class="n">service</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="n">service</span>
</span><span class='line'>            <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;.MyFirebaseInstanceIDService&quot;</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="n">intent</span><span class="o">-</span><span class="n">filter</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="n">action</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;com.google.firebase.INSTANCE_ID_EVENT&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>            <span class="o">&lt;/</span><span class="n">intent</span><span class="o">-</span><span class="n">filter</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;/</span><span class="n">service</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;/</span><span class="n">application</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;/</span><span class="n">manifest</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Android 6.0になってからPermissionについて変わりまして6.0の前まではAndroidManifestに設定したら勝手に権限をとることになったんですが、6.0からは直接確認しないと権限が取れないところがありましてそのセッティングは相当めんどくさいので<br>
私の場合はTedPermissionというライブラリを使いました。<br>
ライブラリを使いたいなら下のようにbundle.gradleに設定したら良いです。
<img src="https://monosnap.com/file/f8JmmzE2Fqy1PFuJ8luT7m2dycRNjh.png" alt="Alt text" /></p>

<h2>4.4以外 <small><small>（Android Version &lt; 3.0&nbsp;&nbsp;/&nbsp;&nbsp;3.0 &lt;= Android Version &lt; 4.1&nbsp;&nbsp;/&nbsp;&nbsp;4.1 &lt;= Android Version &lt; 4.4&nbsp;&nbsp;/&nbsp;&nbsp;Android Version 5.0+）</small></small></h2>

<hr style="border-top: solid 1px rgba(128, 128, 128, 0.2); border-bottom: solid 1px rgba(128, 128, 128, 0.2);"><br>


<h3>共通で使うメソッド</h3>

<p><br></p>

<h4>imageChooser()</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">imageChooser</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Intent</span> <span class="n">takePictureIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="n">MediaStore</span><span class="o">.</span><span class="na">ACTION_IMAGE_CAPTURE</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">takePictureIntent</span><span class="o">.</span><span class="na">resolveActivity</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="na">getPackageManager</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Create the File where the photo should go</span>
</span><span class='line'>        <span class="n">File</span> <span class="n">photoFile</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">photoFile</span> <span class="o">=</span> <span class="n">createImageFile</span><span class="o">();</span>
</span><span class='line'>            <span class="n">takePictureIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;PhotoPath&quot;</span><span class="o">,</span> <span class="n">mCameraPhotoPath</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Error occurred while creating the File</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="s">&quot;Unable to create Image File&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Continue only if the File was successfully created</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">photoFile</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mCameraPhotoPath</span> <span class="o">=</span> <span class="s">&quot;file:&quot;</span><span class="o">+</span><span class="n">photoFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">();</span>
</span><span class='line'>            <span class="n">takePictureIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">MediaStore</span><span class="o">.</span><span class="na">EXTRA_OUTPUT</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">Uri</span><span class="o">.</span><span class="na">fromFile</span><span class="o">(</span><span class="n">photoFile</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">takePictureIntent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Intent</span> <span class="n">contentSelectionIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_GET_CONTENT</span><span class="o">);</span>
</span><span class='line'>    <span class="n">contentSelectionIntent</span><span class="o">.</span><span class="na">addCategory</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">CATEGORY_OPENABLE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">contentSelectionIntent</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">TYPE_IMAGE</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Intent</span><span class="o">[]</span> <span class="n">intentArray</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">takePictureIntent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">intentArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">[]{</span><span class="n">takePictureIntent</span><span class="o">};</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">intentArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Intent</span> <span class="n">chooserIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_CHOOSER</span><span class="o">);</span>
</span><span class='line'>    <span class="n">chooserIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">EXTRA_INTENT</span><span class="o">,</span> <span class="n">contentSelectionIntent</span><span class="o">);</span>
</span><span class='line'>    <span class="n">chooserIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">EXTRA_TITLE</span><span class="o">,</span> <span class="s">&quot;Image Chooser&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">chooserIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">EXTRA_INITIAL_INTENTS</span><span class="o">,</span> <span class="n">intentArray</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">startActivityForResult</span><span class="o">(</span><span class="n">chooserIntent</span><span class="o">,</span> <span class="n">INPUT_FILE_REQUEST_CODE</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br></p>

<h4>createImageFile()</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">File</span> <span class="nf">createImageFile</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// Create an image file name</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">timeStamp</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyyyMMdd_HHmmss&quot;</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nf">Date</span><span class="o">());</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">imageFileName</span> <span class="o">=</span> <span class="s">&quot;JPEG_&quot;</span> <span class="o">+</span> <span class="n">timeStamp</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="n">File</span> <span class="n">storageDir</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="na">getExternalStoragePublicDirectory</span><span class="o">(</span>
</span><span class='line'>            <span class="n">Environment</span><span class="o">.</span><span class="na">DIRECTORY_PICTURES</span><span class="o">);</span>
</span><span class='line'>    <span class="n">File</span> <span class="n">imageFile</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span>
</span><span class='line'>            <span class="n">imageFileName</span><span class="o">,</span>  <span class="cm">/* prefix */</span>
</span><span class='line'>            <span class="s">&quot;.jpg&quot;</span><span class="o">,</span>         <span class="cm">/* suffix */</span>
</span><span class='line'>            <span class="n">storageDir</span>      <span class="cm">/* directory */</span>
</span><span class='line'>    <span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">imageFile</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br></p>

<h4>onActivityResult (int, int, Intent)</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityResult</span> <span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="n">INPUT_FILE_REQUEST_CODE</span> <span class="o">&amp;&amp;</span> <span class="n">resultCode</span> <span class="o">==</span> <span class="n">getActivity</span><span class="o">().</span><span class="na">RESULT_OK</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">filePathCallbackLollipop</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
</span><span class='line'>                <span class="k">return</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">Uri</span><span class="o">[]</span> <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="o">[]{</span><span class="n">getResultUri</span><span class="o">(</span><span class="n">data</span><span class="o">)};</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">filePathCallbackLollipop</span><span class="o">.</span><span class="na">onReceiveValue</span><span class="o">(</span><span class="n">results</span><span class="o">);</span>
</span><span class='line'>            <span class="n">filePathCallbackLollipop</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">filePathCallbackNormal</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
</span><span class='line'>                <span class="k">return</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">Uri</span> <span class="n">result</span> <span class="o">=</span> <span class="n">getResultUri</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="s">&quot;openFileChooser : &quot;</span><span class="o">+</span><span class="n">result</span><span class="o">);</span>
</span><span class='line'>            <span class="n">filePathCallbackNormal</span><span class="o">.</span><span class="na">onReceiveValue</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span><span class='line'>            <span class="n">filePathCallbackNormal</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mFilePathCallback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">mFilePathCallback</span><span class="o">.</span><span class="na">onReceiveValue</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">filePathCallbackNormal</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">filePathCallbackNormal</span><span class="o">.</span><span class="na">onReceiveValue</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="n">mFilePathCallback</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="n">filePathCallbackNormal</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br></p>

<h4>getResultUri(Intent)</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Uri</span> <span class="nf">getResultUri</span><span class="o">(</span><span class="n">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Uri</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getDataString</span><span class="o">()))</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// If there is not data, then we may have taken a photo</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">mCameraPhotoPath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">mCameraPhotoPath</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">filePath</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">filePath</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getDataString</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">filePath</span> <span class="o">=</span> <span class="s">&quot;file:&quot;</span> <span class="o">+</span> <span class="n">RealPathUtil</span><span class="o">.</span><span class="na">getRealPath</span><span class="o">(</span><span class="n">getContext</span><span class="o">(),</span> <span class="n">data</span><span class="o">.</span><span class="na">getData</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br></p>

<h3>バージョン別</h3>

<p><br><strong>
1. Android Version 5.0+<br></strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onShowFileChooser</span><span class="o">(</span><span class="n">WebView</span> <span class="n">webView</span><span class="o">,</span>
</span><span class='line'>                                 <span class="n">ValueCallback</span><span class="o">&lt;</span><span class="n">Uri</span><span class="o">[]&gt;</span> <span class="n">filePathCallback</span><span class="o">,</span> <span class="n">FileChooserParams</span> <span class="n">fileChooserParams</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;WebViewActivity A&gt;5, OS Version : &quot;</span> <span class="o">+</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">+</span> <span class="s">&quot;\t onSFC(WV,VCUB,FCP), n=3&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">filePathCallbackLollipop</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">filePathCallbackLollipop</span><span class="o">.</span><span class="na">onReceiveValue</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">filePathCallbackLollipop</span> <span class="o">=</span> <span class="n">filePathCallback</span><span class="o">;</span>
</span><span class='line'>    <span class="n">imageChooser</span><span class="o">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br><strong>
2. 4.1 &lt;= Android Version &lt; 4.4<br></strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">openFileChooser</span><span class="o">(</span><span class="n">ValueCallback</span><span class="o">&lt;</span><span class="n">Uri</span><span class="o">&gt;</span> <span class="n">uploadFile</span><span class="o">,</span> <span class="n">String</span> <span class="n">acceptType</span><span class="o">,</span> <span class="n">String</span> <span class="n">capture</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="s">&quot;openFileChooser : &quot;</span><span class="o">+</span><span class="n">acceptType</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">capture</span><span class="o">);</span>
</span><span class='line'>    <span class="n">filePathCallbackNormal</span> <span class="o">=</span> <span class="n">uploadFile</span><span class="o">;</span>
</span><span class='line'>    <span class="n">imageChooser</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br><strong>
3. 3.0 &lt;= Android Version &lt; 4.1<br></strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">openFileChooser</span><span class="o">(</span><span class="n">ValueCallback</span><span class="o">&lt;</span><span class="n">Uri</span><span class="o">&gt;</span> <span class="n">uploadMsg</span><span class="o">,</span> <span class="n">String</span> <span class="n">acceptType</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">//System.out.println(&quot;WebViewActivity 3&lt;A&lt;4.1, OS Version : &quot; + Build.VERSION.SDK_INT + &quot;\t openFC(VCU,aT), n=2&quot;);</span>
</span><span class='line'>    <span class="n">filePathCallbackNormal</span> <span class="o">=</span> <span class="n">uploadFile</span><span class="o">;</span>
</span><span class='line'>    <span class="n">imageChooser</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br><strong>
4. Android Version &lt; 3.0<br></strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">openFileChooser</span><span class="o">(</span><span class="n">ValueCallback</span><span class="o">&lt;</span><span class="n">Uri</span><span class="o">&gt;</span> <span class="n">uploadMsg</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">//System.out.println(&quot;WebViewActivity OS Version : &quot; + Build.VERSION.SDK_INT + &quot;\t openFC(VCU), n=1&quot;);</span>
</span><span class='line'>    <span class="n">filePathCallbackNormal</span> <span class="o">=</span> <span class="n">uploadMsg</span><span class="o">;</span>
</span><span class='line'>    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_GET_CONTENT</span><span class="o">);</span>
</span><span class='line'>    <span class="n">intent</span><span class="o">.</span><span class="na">addCategory</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">CATEGORY_OPENABLE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">intent</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">TYPE_IMAGE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">startActivityForResult</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">INPUT_FILE_REQUEST_CODE</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><br></p>

<h2>テスト</h2>

<hr style="border-top: solid 1px rgba(128, 128, 128, 0.2); border-bottom: solid 1px rgba(128, 128, 128, 0.2);"><br>


<p><br><strong>
1. Android 6.0<br></strong><br>
<img src="https://monosnap.com/file/i4St10LZC6hGt5xvI8PecmQMXk0tcd.png" style="width: 50%; float: left;">
<img src="https://monosnap.com/file/EfhnOQcLSkzNMxOj1wQB7yZlF9kzs6.png" style="width: 50%;">
<br><strong><br>
2. Android 5.1<br></strong><br>
<img src="https://monosnap.com/file/mcgXOTDiBcfMMPGsPr31GvBQrDiCME.png" style="width: 50%; float: left;">
<img src="https://monosnap.com/file/HHnJECNfOfRm9mx3gMDuofUXUfNzDC.png" style="width: 50%;">
<br><strong><br>
3. Android 4.2<br></strong><br>
<img src="https://monosnap.com/file/rpTQ1JSdrqyULk7VMhACNKqxFctp1s.png" style="width: 50%; float: left;">
<img src="https://monosnap.com/file/wGalecUVjVX5q0GVkpxYQcAfj3s6Ua.png" style="width: 50%;"></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/6">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/4">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Jo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
